# Development Plan — v0.2

In-progress milestones for kiso v0.2. Continues from v0.1 (all M1–M43 complete).

## Principles

- **Agile**: smallest testable increment first, then layer on
- **No dead code**: every line written is immediately reachable and testable
- **Fail loud**: missing config, broken provider, invalid input → clear error, never silent fallback
- **Tested**: every milestone adds tests. `uv run pytest` must pass before moving on.

---

## Milestone 44: Deferred items + polish

Collect all items explicitly deferred during v0.1 development, plus small UX fixes observed in production.

### 44a. worker — estrai `search.py` da `loop.py`

**Problema**: M36 prevedeva `kiso/worker/search.py` come modulo dedicato al search handler (analogo a `exec.py` e `skill.py`). La logica è invece rimasta in `loop.py`, rompendo la simmetria del package. Il `__init__.py` non esporta nulla di search-related.

**Fix**: estrarre il search handler da `loop.py` in `kiso/worker/search.py`, analogamente a `exec.py` e `skill.py`. Aggiornare `__init__.py` e gli import.

- [x] `kiso/worker/search.py`: nuovo modulo con `_parse_search_args()` e `_search_task()` estratti da `loop.py`
- [x] `kiso/worker/loop.py`: rimosso il parsing inline degli args e la chiamata `run_searcher` diretta; usa `_search_task()`
- [x] `kiso/worker/__init__.py`: esporta `_parse_search_args` e `_search_task`
- [x] `tests/test_worker.py`: aggiornati i patch target da `kiso.worker.loop.run_searcher` a `kiso.worker.search.run_searcher` (17 occorrenze)
- [x] `tests/test_search.py`: 33 unit test isolati per `_parse_search_args` e `_search_task` (boundary max_results, type errors, malformed JSON, warning log, propagazione parametri)
- [x] 1540 test passati

---

### 44b. CLI — loader on new line

**Problem**: the "thinking..." spinner appears inline with the last content line instead of on its own line. Visually confusing when the previous output ends without a trailing newline.

**Fix**: ensure the loader/spinner always starts on a fresh line.

- [x] `cli/__init__.py`: `_poll_status` gains `_at_col0: bool = True` parameter; emits `\n` before first frame when `_at_col0=False`
- [x] tests: 2 new cases verify `\n\n\r` (extra newline) vs `\n\r` (no extra newline)

---

### 44c. Fact poisoning — `save_learning` content filter

**Context**: during M21 the curator prompt was deemed sufficient to guard against manipulative learnings. Monitor in production whether this holds or whether pre-storage filtering is needed.

- [x] Added `_SENSITIVE_PATTERN` regex + filter in `save_learning()` (keywords: password/passwd/token, hex ≥32 chars); returns 0 + logs warning
- [x] 7 unit tests: keyword rejection (case-insensitive), hex threshold, benign acceptance, sentinel preservation

---

### 44d. Verbose mode — incremental LLM rendering

**Context**: `append_task_llm_call()` was added in M31 but the worker still batches all LLM call data at task end. Documented as known limitation in `docs/cli.md`.

**Fix**: call `append_task_llm_call()` after each individual LLM call (searcher, exec translator, reviewer, messenger) so verbose panels appear incrementally during task execution.

- [x] `kiso/worker/loop.py`: `_append_calls()` helper added; called after each LLM op (translator, reviewer, messenger, searcher) in all task branches and fast-path
- [x] `llm_calls=` removed from all `update_task_usage` call sites; `_KEEP_LLM_CALLS` sentinel preserves incrementally-appended column
- [x] `docs/cli.md`: removed "Known limitations — batch rendering" note
- [x] 5 tests: assert `_append_calls` call count per task type; verify `update_task_usage` called without explicit `llm_calls`

---

### 44e. Post-review hardening — M44b/M44c/M44d follow-up

Problemi di alta/media severità emersi dalla review di M44b+M44d.

#### Alta severità

- [x] `cli/__init__.py`: docstring completa per `_poll_status()` con spiegazione del parametro `_at_col0`
- [x] `kiso/store.py`: `save_learning()` — TypeError su `content=None`; return 0 su stringa vuota/whitespace; docstring aggiornata
- [x] `kiso/worker/loop.py`: `_append_calls()` — `try/except Exception` con log.warning; nessun crash del worker per errori di usage tracking
- [x] `kiso/worker/loop.py`: `_fast_path_chat()` — `_append_calls()` chiamata anche nel failure path (eccez. messenger)

#### Media severità

- [x] `tests/test_store.py`: guard None (TypeError), stringa vuota, whitespace, boundary hex 31 chars (accettato) vs 32 chars (rifiutato)
- [x] `tests/test_worker.py`: `_append_calls` handles exception, fast_path failure appends, success vs failure same call_count; retry scenario verifica 5 `_append_calls` (2 tentativi × 2 + 1 msg)
- [x] `tests/test_cli.py`: `\n\n\r` appare esattamente una volta — extra newline solo al primo frame, non ai frame successivi

---

### 44f. Admin context — session labels on facts

**Context**: M43 implemented strict session scoping for regular users (Option B). Admin users already bypass the filter and receive all facts, but with no indication of which session each fact originated from, making cross-session facts indistinguishable in the planner context.

**Fix**: when building planner context for an admin caller, split facts into two priority tiers:
- **Primary** (`## Known Facts`): facts from the current session + global facts (session IS NULL). Shown without session label — these are the most relevant.
- **Background** (`## Context from Other Sessions`): facts from other sessions, annotated with `[session:<name>]`. Available as broader memory if needed.

Non-admin path is unchanged (single `## Known Facts` block, no labels).

- [x] `kiso/brain.py`: `build_planner_messages()` — admin path splits `facts` into `primary` and `other`; `_group_by_category()` helper renders both blocks; non-admin uses `primary=facts, other=[]`
- [x] `tests/test_brain.py`: `test_admin_facts_hierarchy` — current-session + global facts in `## Known Facts` (no label); other-session fact in `## Context from Other Sessions` with `[session:name]`; current-session fact never carries a label
- [x] `tests/test_brain.py`: `test_non_admin_facts_no_session_labels` — non-admin context has no `[session:` and no `## Context from Other Sessions`

---

## Milestone 45: Planner — plugin discovery via registry (not web search)

**Problema osservato in produzione**: l'utente chiede "voglio installare connettore discord" e il planner emette `[search] kiso discord connector` (web search) invece di `[exec] curl <registry_url>`. Il reviewer correttamente rigetta il risultato ("sa-mp discord connector", non quello kiso), ma il ciclo è sprecato.

**Cause root**:
1. La rule "Prefer search over exec curl/wget for web lookups" nel task type `search` non aveva l'eccezione esplicita per il registry kiso.
2. Le regole MANDATORY sulla discovery via registry erano seppellite in fondo e non collegavano esplicitamente l'eccezione alla rule search.
3. `kiso` non era in `PROBE_BINARIES` → non compariva nella lista "available binaries" del System Environment.

**Fix**:

- [x] `kiso/roles/planner.md`: aggiunta eccezione esplicita nella description del task `search`: "NEVER use search to discover kiso plugins — use exec curl on the registry URL instead (see Plugin installation rule below)"
- [x] `kiso/roles/planner.md`: regole MANDATORY unificate e riscritte come "Plugin installation (MANDATORY)": unico blocco che copre discovery (exec curl registry, mai web search) + install + env requirements
- [x] `kiso/sysenv.py`: aggiunto `"kiso"` in testa a `PROBE_BINARIES` — il binario appare in "available binaries" se installato, rendendo esplicita la sua disponibilità al planner
- [x] `tests/test_brain.py`: `test_m45_plugin_install_uses_registry_not_search` — verifica che il prompt contenga "NEVER" + "registry" + "web search"
- [x] `tests/test_brain.py`: `test_m45_plugin_install_rule_is_mandatory` — verifica che "Plugin installation (MANDATORY)" sia nel prompt
- [x] `tests/test_sysenv.py`: `test_kiso_in_probe_list` — verifica che `"kiso"` sia in `PROBE_BINARIES`
- [x] `docs/flow.md`: aggiornate sezioni "Facts" (era "global", ora "session-scoped"), "Planner Context" (aggiunto esempio admin con `## Context from Other Sessions`)
- [x] `docs/security-risks.md`: aggiornate due sezioni obsolete ("Facts are global" → scoping M43 + residual risk per categorie globali)
- [x] `docs/llm-roles.md`: aggiornata tabella contesto ("Facts (global)" → "Facts (session-scoped; admin sees all)")

---

## Milestone 46: Plugin install — ask env vars before installing, with how-to instructions

**Problema osservato in produzione**: il planner installava il connettore discord, poi scopriva le env var mancanti dall'output di install, e solo alla fine chiedeva i valori all'utente. Doppio problema:
1. L'utente aspetta tutto il processo di install prima di essere interrogato.
2. Il messaggio all'utente non spiegava come ottenere i valori (dove trovare il bot token, cosa è il kiso token, ecc.).

**Cause root**:
1. Il prompt del planner diceva "install, then check" — ordine sbagliato.
2. `kiso.toml` del connettore discord non aveva `description` nei campi env var.
3. `cli/connector.py` stampava solo `warning: VAR not set`, senza descrizione.

**Fix**:

- [x] `plugins/connector-discord/kiso.toml`: aggiunto campo `description` a ogni env var (`bot_token`, `kiso_token`, `webhook_secret`) con istruzioni su come ottenerli
- [x] `cli/connector.py`: `_connector_install()` — stampa `(required|optional) — {description}` accanto a ogni warning di env var mancante; usa `decl.items()` invece di `for key in env_decl` per accedere alle descrizioni
- [x] `kiso/roles/planner.md`: regola "Plugin installation (MANDATORY)" riscritta come lista ordinata di 6 step: (1) curl registry, (2) curl kiso.toml da GitHub PRIMA di installare, (3) msg user con descrizioni se env var mancanti, (4) kiso env set, (5) install, (6) run
- [x] `tests/test_cli_connector.py`: `test_connector_install_env_warning_includes_description` — verifica che l'output di install contenga la description accanto al warning per required e optional
- [x] `tests/test_brain.py`: `test_m46_plugin_install_checks_kiso_toml_before_install` — verifica che raw.githubusercontent.com/kiso.toml appaia prima di `kiso connector install` nel prompt
- [x] `tests/test_brain.py`: `test_m46_plugin_install_includes_env_description_in_msg` — verifica che il prompt istruisca il planner a includere le descrizioni nel messaggio all'utente

---
