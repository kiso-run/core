# Development Plan — v0.2

In-progress milestones for kiso v0.2. Continues from v0.1 (all M1–M43 complete).

## Principles

- **Agile**: smallest testable increment first, then layer on
- **No dead code**: every line written is immediately reachable and testable
- **Fail loud**: missing config, broken provider, invalid input → clear error, never silent fallback
- **Tested**: every milestone adds tests. `uv run pytest` must pass before moving on.

---

## Milestone 44: Deferred items + polish

Collect all items explicitly deferred during v0.1 development, plus small UX fixes observed in production.

### 44a. CLI — loader on new line

**Problem**: the "thinking..." spinner appears inline with the last content line instead of on its own line. Visually confusing when the previous output ends without a trailing newline.

**Fix**: ensure the loader/spinner always starts on a fresh line.

- [ ] `cli/__init__.py` / `cli/render.py`: print a newline before emitting the spinner if the cursor is not at column 0
- [ ] tests: spinner always appears on its own line regardless of preceding output

---

### 44b. Fact poisoning — `save_learning` content filter

**Context**: during M21 the curator prompt was deemed sufficient to guard against manipulative learnings. Monitor in production whether this holds or whether pre-storage filtering is needed.

- [ ] Decide: add a lightweight content filter in `save_learning()` to reject strings matching secret-like patterns (e.g. `password`, `token`, hex strings) before storage
- [ ] If adding: unit test that a "The admin password is hunter2" string is rejected at storage time, not only at curator evaluation

---

### 44c. Fact consolidation — soft delete

**Context**: during M21, hard-delete + `facts_archive` was chosen as sufficient. Revisit if rollback needs arise.

- [ ] Decide: replace hard-delete in consolidation with soft-delete (keep original rows flagged as `archived=true`, query filters them out)
- [ ] If implementing: migration, updated `get_facts()` / `search_facts()` filter, tests

---

### 44d. Reviewer rubber-stamp monitoring

**Context**: during M21e the exit code was added to reviewer context. Auto-replan on exec failure regardless of reviewer verdict was deferred pending production observation.

- [ ] After sufficient production data: decide if `exit_code != 0` should force replan even when reviewer says "ok"
- [ ] If implementing: worker guard in `exec.py`, unit test, reviewer prompt update

---

### 44e. Verbose mode — incremental LLM rendering

**Context**: `append_task_llm_call()` was added in M31 but the worker still batches all LLM call data at task end. Documented as known limitation in `docs/cli.md`.

**Fix**: call `append_task_llm_call()` after each individual LLM call (searcher, exec translator, reviewer, messenger) so verbose panels appear incrementally during task execution.

- [ ] `kiso/worker/exec.py`: append after translator call, after reviewer call
- [ ] `kiso/worker/search.py`: append after searcher call, after reviewer call
- [ ] `kiso/worker/msg.py`: append after messenger call
- [ ] Avoid duplicate data: drop the bulk `update_task_usage(llm_calls=...)` at task end, or deduplicate
- [ ] Update `docs/cli.md`: remove "Known limitations" note
- [ ] tests: verify panels appear after each call (poll between LLM calls in test)

---

### 44f. Session-scoped facts — Option A (cross-session user facts)

**Context**: M43 implemented strict session scoping (Option B). Option A — personal preferences following a user across all their sessions — was deferred as unnecessary complexity at the time.

- [ ] Evaluate if re-learning personal preferences per-channel is causing friction in practice
- [ ] If implementing Option A: `get_facts()` with `username` parameter; query sessions where user has sent messages; return `user` facts from all those sessions
- [ ] Migration: no schema change needed (session column already exists)
- [ ] Tests: user fact from session A visible in session B when same username; not visible to different user

---
