# Development Plan — v0.2

In-progress milestones for kiso v0.2. Continues from v0.1 (all M1–M43 complete).

## Principles

- **Agile**: smallest testable increment first, then layer on
- **No dead code**: every line written is immediately reachable and testable
- **Fail loud**: missing config, broken provider, invalid input → clear error, never silent fallback
- **Tested**: every milestone adds tests. `uv run pytest` must pass before moving on.

---

## Milestone 44: Deferred items + polish

Collect all items explicitly deferred during v0.1 development, plus small UX fixes observed in production.

### 44a. worker — estrai `search.py` da `loop.py`

**Problema**: M36 prevedeva `kiso/worker/search.py` come modulo dedicato al search handler (analogo a `exec.py` e `skill.py`). La logica è invece rimasta in `loop.py`, rompendo la simmetria del package. Il `__init__.py` non esporta nulla di search-related.

**Fix**: estrarre il search handler da `loop.py` in `kiso/worker/search.py`, analogamente a `exec.py` e `skill.py`. Aggiornare `__init__.py` e gli import.

- [x] `kiso/worker/search.py`: nuovo modulo con `_parse_search_args()` e `_search_task()` estratti da `loop.py`
- [x] `kiso/worker/loop.py`: rimosso il parsing inline degli args e la chiamata `run_searcher` diretta; usa `_search_task()`
- [x] `kiso/worker/__init__.py`: esporta `_parse_search_args` e `_search_task`
- [x] `tests/test_worker.py`: aggiornati i patch target da `kiso.worker.loop.run_searcher` a `kiso.worker.search.run_searcher` (17 occorrenze)
- [x] `tests/test_search.py`: 33 unit test isolati per `_parse_search_args` e `_search_task` (boundary max_results, type errors, malformed JSON, warning log, propagazione parametri)
- [x] 1540 test passati

---

### 44b. CLI — loader on new line

**Problem**: the "thinking..." spinner appears inline with the last content line instead of on its own line. Visually confusing when the previous output ends without a trailing newline.

**Fix**: ensure the loader/spinner always starts on a fresh line.

- [x] `cli/__init__.py`: `_poll_status` gains `_at_col0: bool = True` parameter; emits `\n` before first frame when `_at_col0=False`
- [x] tests: 2 new cases verify `\n\n\r` (extra newline) vs `\n\r` (no extra newline)

---

### 44b. Fact poisoning — `save_learning` content filter

**Context**: during M21 the curator prompt was deemed sufficient to guard against manipulative learnings. Monitor in production whether this holds or whether pre-storage filtering is needed.

- [x] Added `_SENSITIVE_PATTERN` regex + filter in `save_learning()` (keywords: password/passwd/token, hex ≥32 chars); returns 0 + logs warning
- [x] 7 unit tests: keyword rejection (case-insensitive), hex threshold, benign acceptance, sentinel preservation

---

### 44c. Fact consolidation — soft delete

**Context**: during M21, hard-delete + `facts_archive` was chosen as sufficient. Revisit if rollback needs arise.

- [ ] Decide: replace hard-delete in consolidation with soft-delete (keep original rows flagged as `archived=true`, query filters them out)
- [ ] If implementing: migration, updated `get_facts()` / `search_facts()` filter, tests

---

### 44d. Reviewer rubber-stamp monitoring

**Context**: during M21e the exit code was added to reviewer context. Auto-replan on exec failure regardless of reviewer verdict was deferred pending production observation.

- [ ] After sufficient production data: decide if `exit_code != 0` should force replan even when reviewer says "ok"
- [ ] If implementing: worker guard in `exec.py`, unit test, reviewer prompt update

---

### 44e. Verbose mode — incremental LLM rendering

**Context**: `append_task_llm_call()` was added in M31 but the worker still batches all LLM call data at task end. Documented as known limitation in `docs/cli.md`.

**Fix**: call `append_task_llm_call()` after each individual LLM call (searcher, exec translator, reviewer, messenger) so verbose panels appear incrementally during task execution.

- [x] `kiso/worker/loop.py`: `_append_calls()` helper added; called after each LLM op (translator, reviewer, messenger, searcher) in all task branches and fast-path
- [x] `llm_calls=` removed from all `update_task_usage` call sites; `_KEEP_LLM_CALLS` sentinel preserves incrementally-appended column
- [x] `docs/cli.md`: removed "Known limitations — batch rendering" note
- [x] 5 tests: assert `_append_calls` call count per task type; verify `update_task_usage` called without explicit `llm_calls`

---

### 44g. Post-review hardening — M44b/M44e follow-up

Problemi di alta/media severità emersi dalla review di M44b+M44e.

#### Alta severità

- [x] `cli/__init__.py`: docstring completa per `_poll_status()` con spiegazione del parametro `_at_col0`
- [x] `kiso/store.py`: `save_learning()` — TypeError su `content=None`; return 0 su stringa vuota/whitespace; docstring aggiornata
- [x] `kiso/worker/loop.py`: `_append_calls()` — `try/except Exception` con log.warning; nessun crash del worker per errori di usage tracking
- [x] `kiso/worker/loop.py`: `_fast_path_chat()` — `_append_calls()` chiamata anche nel failure path (eccez. messenger)

#### Media severità

- [x] `tests/test_store.py`: guard None (TypeError), stringa vuota, whitespace, boundary hex 31 chars (accettato) vs 32 chars (rifiutato)
- [x] `tests/test_worker.py`: `_append_calls` handles exception, fast_path failure appends, success vs failure same call_count; retry scenario verifica 5 `_append_calls` (2 tentativi × 2 + 1 msg)
- [x] `tests/test_cli.py`: `\n\n\r` appare esattamente una volta — extra newline solo al primo frame, non ai frame successivi

---

### 44f. Session-scoped facts — Option A (cross-session user facts)

**Context**: M43 implemented strict session scoping (Option B). Option A — personal preferences following a user across all their sessions — was deferred as unnecessary complexity at the time.

- [ ] Evaluate if re-learning personal preferences per-channel is causing friction in practice
- [ ] If implementing Option A: `get_facts()` with `username` parameter; query sessions where user has sent messages; return `user` facts from all those sessions
- [ ] Migration: no schema change needed (session column already exists)
- [ ] Tests: user fact from session A visible in session B when same username; not visible to different user

---
